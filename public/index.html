<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Groundwater Assistant</title>
    <style>
      :root {
        --bg: #f7f8ff;
        --panel: rgba(255, 255, 255, 0.72);
        --border: rgba(108, 122, 255, 0.2);
        --accent: #6b7bff;
        --accent-2: #7fd1ff;
        --text: #1f2a44;
        --muted: #6c7690;
        --shadow: 0 20px 80px rgba(94, 118, 255, 0.18);
        --radius: 18px;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        background: radial-gradient(circle at 20% 20%, rgba(127, 209, 255, 0.25), transparent 35%),
          radial-gradient(circle at 80% 20%, rgba(107, 123, 255, 0.2), transparent 30%),
          var(--bg);
        font-family: "Inter", system-ui, -apple-system, sans-serif;
        color: var(--text);
      }

      .page {
        max-width: 960px;
        margin: 0 auto;
        padding: 56px 20px 80px;
        display: flex;
        flex-direction: column;
        gap: 22px;
      }

      .orb {
        width: 80px;
        height: 80px;
        margin: 0 auto;
        border-radius: 50%;
        background: radial-gradient(circle at 30% 30%, #fff, rgba(255, 255, 255, 0)),
          radial-gradient(circle at 70% 30%, #7fd1ff, rgba(255, 255, 255, 0)),
          radial-gradient(circle at 50% 70%, #6b7bff, rgba(255, 255, 255, 0));
        filter: drop-shadow(0 10px 30px rgba(107, 123, 255, 0.35));
      }

      .headline {
        text-align: center;
        margin: 0;
        line-height: 1.2;
      }

      .headline strong {
        color: #111827;
        font-size: 28px;
        display: block;
      }

      .headline span {
        color: var(--accent);
        font-weight: 700;
      }

      .card {
        background: var(--panel);
        border-radius: var(--radius);
        border: 1px solid var(--border);
        box-shadow: var(--shadow);
        padding: 18px;
        backdrop-filter: blur(12px);
      }

      .input-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 12px;
        align-items: start;
      }

      label {
        display: block;
        font-size: 13px;
        color: var(--muted);
        margin-bottom: 6px;
      }

      select,
      input,
      button {
        width: 100%;
        padding: 12px 12px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.9);
        font-size: 15px;
        color: var(--text);
        outline: none;
      }

      button {
        background: linear-gradient(120deg, var(--accent), var(--accent-2));
        color: #fff;
        font-weight: 700;
        cursor: pointer;
        box-shadow: 0 12px 30px rgba(107, 123, 255, 0.35);
        border: none;
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        box-shadow: none;
      }

      .years {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
      }

      .years label {
        margin: 0;
        color: var(--text);
      }

      .actions {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-top: 12px;
      }

      .error {
        color: #e02424;
        margin: 0;
        font-size: 14px;
      }

      .muted {
        color: var(--muted);
      }

      .results {
        margin-top: 12px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      th,
      td {
        padding: 10px 8px;
        text-align: left;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      }

      th {
        color: var(--muted);
        font-weight: 600;
      }

      .loading {
        display: inline-flex;
        gap: 8px;
        align-items: center;
      }

      .dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--accent);
        animation: pulse 1.2s ease-in-out infinite;
      }

      .dot:nth-child(2) {
        animation-delay: 0.2s;
      }
      .dot:nth-child(3) {
        animation-delay: 0.4s;
      }

      @keyframes pulse {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-3px);
        }
      }

      /* Chatbot Styles */
      .chatbot-toggle {
        position: fixed;
        top: 50%;
        right: 20px;
        transform: translateY(-50%);
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(120deg, var(--accent), var(--accent-2));
        border: none;
        color: white;
        font-size: 24px;
        cursor: pointer;
        box-shadow: 0 8px 25px rgba(107, 123, 255, 0.4);
        z-index: 1000;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .chatbot-toggle:hover {
        transform: translateY(-50%) scale(1.1);
        box-shadow: 0 12px 35px rgba(107, 123, 255, 0.6);
      }

      .chatbot-drawer {
        position: fixed;
        top: 0;
        right: -400px;
        width: 380px;
        height: 100vh;
        background: var(--panel);
        border-left: 1px solid var(--border);
        box-shadow: -10px 0 40px rgba(0, 0, 0, 0.1);
        z-index: 999;
        transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        flex-direction: column;
        backdrop-filter: blur(12px);
      }

      .chatbot-drawer.open {
        right: 0;
      }

      .chatbot-header {
        padding: 20px;
        border-bottom: 1px solid var(--border);
        background: linear-gradient(120deg, var(--accent), var(--accent-2));
        color: white;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .chatbot-title {
        font-size: 18px;
        font-weight: 700;
        margin: 0;
      }

      .chatbot-close {
        background: none;
        border: none;
        color: white;
        font-size: 20px;
        cursor: pointer;
        padding: 5px;
        border-radius: 50%;
        transition: background 0.2s ease;
      }

      .chatbot-close:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      .chatbot-messages {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .message {
        max-width: 80%;
        padding: 12px 16px;
        border-radius: 18px;
        font-size: 14px;
        line-height: 1.4;
        animation: slideIn 0.3s ease-out;
      }

      .message.user {
        align-self: flex-end;
        background: linear-gradient(120deg, var(--accent), var(--accent-2));
        color: white;
        border-bottom-right-radius: 4px;
      }

      .message.bot {
        align-self: flex-start;
        background: rgba(255, 255, 255, 0.9);
        color: var(--text);
        border-bottom-left-radius: 4px;
        border: 1px solid var(--border);
      }

      .message.typing {
        align-self: flex-start;
        background: rgba(255, 255, 255, 0.9);
        color: var(--muted);
        border: 1px solid var(--border);
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .typing-dots {
        display: flex;
        gap: 4px;
      }

      .typing-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: var(--accent);
        animation: typingPulse 1.4s ease-in-out infinite;
      }

      .typing-dot:nth-child(2) {
        animation-delay: 0.2s;
      }

      .typing-dot:nth-child(3) {
        animation-delay: 0.4s;
      }

      .chatbot-input-area {
        padding: 20px;
        border-top: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.9);
      }

      .chatbot-input-container {
        display: flex;
        gap: 12px;
        align-items: center;
      }

      .chatbot-input {
        flex: 1;
        padding: 12px 16px;
        border-radius: 25px;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.9);
        font-size: 14px;
        outline: none;
        transition: border-color 0.2s ease;
      }

      .chatbot-input:focus {
        border-color: var(--accent);
      }

      .chatbot-send {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background: linear-gradient(120deg, var(--accent), var(--accent-2));
        border: none;
        color: white;
        font-size: 18px;
        cursor: pointer;
        transition: transform 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .chatbot-send:hover {
        transform: scale(1.1);
      }

      .chatbot-send:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes typingPulse {
        0%, 80%, 100% {
          transform: scale(0);
          opacity: 0.5;
        }
        40% {
          transform: scale(1);
          opacity: 1;
        }
      }

      @media (max-width: 640px) {
        .headline strong {
          font-size: 22px;
        }
        .page {
          padding: 32px 14px 48px;
        }

        .chatbot-drawer {
          width: 100vw;
          right: -100vw;
        }

        .chatbot-toggle {
          right: 10px;
        }
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <!-- Chatbot Toggle Button -->
    <button class="chatbot-toggle" id="chatbot-toggle" title="Open Chatbot">
      ðŸ’¬
    </button>

    <!-- Chatbot Drawer -->
    <div class="chatbot-drawer" id="chatbot-drawer">
      <div class="chatbot-header">
        <h3 class="chatbot-title">JalSathi Assistant</h3>
        <button class="chatbot-close" id="chatbot-close" title="Close Chatbot">Ã—</button>
      </div>

      <div class="chatbot-messages" id="chatbot-messages">
        <div class="message bot">
          Hello! I'm JalSathi, your groundwater assistant. How can I help you today?
        </div>
      </div>

      <div class="chatbot-input-area">
        <div class="chatbot-input-container">
          <input
            type="text"
            class="chatbot-input"
            id="chatbot-input"
            placeholder="Ask me about groundwater data..."
            maxlength="500"
          />
          <button class="chatbot-send" id="chatbot-send" title="Send Message">
            âž¤
          </button>
        </div>
      </div>
    </div>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script type="text/javascript">
      const { useEffect, useState, useMemo } = React;
      const API_BASE = "/api";

      async function fetchJSON(url, options = {}) {
        const res = await fetch(url, options);
        if (!res.ok) {
          const text = await res.text();
          throw new Error(text || "Request failed");
        }
        return res.json();
      }

      function App() {
        const [states, setStates] = useState([]);
        const [districts, setDistricts] = useState([]);
        const [blocks, setBlocks] = useState([]);
        const [form, setForm] = useState({
          state: "",
          district: "",
          block: "",
          years: { 2023: true, 2024: true },
        });
        const [loadingMeta, setLoadingMeta] = useState(false);
        const [loadingData, setLoadingData] = useState(false);
        const [error, setError] = useState("");
        const [results, setResults] = useState(null);

        useEffect(() => {
          const loadStates = async () => {
            setLoadingMeta(true);
            try {
              const res = await fetchJSON(API_BASE + "/meta/states");
              setStates(res || []);
            } catch (err) {
              console.error(err);
              setError("Unable to load states.");
            } finally {
              setLoadingMeta(false);
            }
          };
          loadStates();
        }, []);

        const handleStateChange = async (value) => {
          setForm((prev) => ({ ...prev, state: value, district: "", block: "" }));
          setDistricts([]);
          setBlocks([]);
          if (!value) return;
          try {
            const res = await fetchJSON(API_BASE + "/meta/districts?state=" + encodeURIComponent(value));
            setDistricts(res || []);
          } catch (err) {
            console.error(err);
            setError("Unable to load districts.");
          }
        };

        const handleDistrictChange = async (value) => {
          setForm((prev) => ({ ...prev, district: value, block: "" }));
          setBlocks([]);
          if (!value || !form.state) return;
          try {
            const res = await fetchJSON(
              API_BASE +
                "/meta/blocks?state=" +
                encodeURIComponent(form.state) +
                "&district=" +
                encodeURIComponent(value)
            );
            setBlocks(res || []);
          } catch (err) {
            console.error(err);
            setError("Unable to load blocks.");
          }
        };

        const toggleYear = (year) => {
          setForm((prev) => ({
            ...prev,
            years: { ...prev.years, [year]: !prev.years[year] },
          }));
        };

        const selectedYears = useMemo(() => {
          return Object.entries(form.years)
            .filter(([, v]) => v)
            .map(([k]) => Number(k));
        }, [form.years]);

        const handleSubmit = async () => {
          setError("");
          if (!form.state && !form.district && !form.block) {
            setError("Please pick at least one of state, district, or block.");
            return;
          }
          setLoadingData(true);
          setResults(null);
          try {
            const payload = {
              state: form.state || null,
              district: form.district || null,
              block: form.block || null,
              years: selectedYears.length ? selectedYears : [],
            };
            const res = await fetchJSON(API_BASE + "/query", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });
            setResults(res);
          } catch (err) {
            console.error(err);
            setError("No data found for this combination. Try changing the filters.");
          } finally {
            setLoadingData(false);
          }
        };

        return React.createElement(
          "div",
          { className: "page" },
          React.createElement("div", { className: "orb" }),
          React.createElement(
            "h1",
            { className: "headline" },
            React.createElement("strong", null, "Good Morning, JalSathi"),
            React.createElement("span", null, "How can I assist you today?")
          ),
          React.createElement(
            "div",
            { className: "card" },
            React.createElement(
              "div",
              { className: "input-row" },
              React.createElement(
                "div",
                null,
                React.createElement("label", null, "State"),
                React.createElement(
                  "select",
                  {
                    value: form.state,
                    onChange: (e) => handleStateChange(e.target.value),
                    disabled: loadingMeta || loadingData,
                  },
                  React.createElement("option", { value: "" }, "Select state"),
                  states.map((s) => React.createElement("option", { key: s, value: s }, s))
                )
              ),
              React.createElement(
                "div",
                null,
                React.createElement("label", null, "District"),
                React.createElement(
                  "select",
                  {
                    value: form.district,
                    onChange: (e) => handleDistrictChange(e.target.value),
                    disabled: !form.state || loadingData,
                  },
                  React.createElement("option", { value: "" }, "Select district"),
                  districts.map((d) => React.createElement("option", { key: d, value: d }, d))
                )
              ),
              React.createElement(
                "div",
                null,
                React.createElement("label", null, "Block / Assessment Unit"),
                React.createElement(
                  "select",
                  {
                    value: form.block,
                    onChange: (e) =>
                      setForm((prev) => ({ ...prev, block: e.target.value })),
                    disabled: !form.state || !form.district || loadingData,
                  },
                  React.createElement("option", { value: "" }, "Select block"),
                  blocks.map((b) => React.createElement("option", { key: b, value: b }, b))
                )
              )
            ),
            React.createElement(
              "div",
              { style: { marginTop: 12 } },
              React.createElement("label", null, "Years"),
              React.createElement(
                "div",
                { className: "years" },
                [2023, 2024].map((year) =>
                  React.createElement(
                    "label",
                    { key: year },
                    React.createElement("input", {
                      type: "checkbox",
                      checked: !!form.years[year],
                      onChange: () => toggleYear(year),
                    }),
                    "\u00a0",
                    year
                  )
                ),
                React.createElement(
                  "span",
                  { className: "muted" },
                  "Select none to use the latest year."
                )
              )
            ),
            React.createElement(
              "div",
              { className: "actions" },
              React.createElement(
                "button",
                { onClick: handleSubmit, disabled: loadingData },
                loadingData
                  ? React.createElement(
                      "span",
                      { className: "loading" },
                      React.createElement("span", { className: "dot" }),
                      React.createElement("span", { className: "dot" }),
                      React.createElement("span", { className: "dot" }),
                      React.createElement("span", null, "Loading...")
                    )
                  : "Get Data"
              ),
              error ? React.createElement("p", { className: "error" }, error) : null
            ),
            React.createElement(
              "div",
              { className: "results" },
              !results && !error
                ? React.createElement("p", { className: "muted" }, "Results will appear here.")
                : null,
              results && results.years && results.years.length > 0
                ? React.createElement(
                    React.Fragment,
                    null,
                    React.createElement(
                      "p",
                      null,
                      React.createElement("strong", null, "Location:"),
                      " ",
                      [
                        results.locationSummary && results.locationSummary.state,
                        results.locationSummary && results.locationSummary.district,
                        results.locationSummary && results.locationSummary.block,
                      ]
                        .filter(Boolean)
                        .join(" \u203a ") || "All"
                    ),
                    React.createElement(
                      "table",
                      null,
                      React.createElement(
                        "thead",
                        null,
                        React.createElement(
                          "tr",
                          null,
                          [
                            "Year",
                            "Annual Extractable (Ham)",
                            "Total Extraction (Ham)",
                            "Stage (%)",
                            "Categorization",
                          ].map((h) => React.createElement("th", { key: h }, h))
                        )
                      ),
                      React.createElement(
                        "tbody",
                        null,
                        results.years.map((y) =>
                          React.createElement(
                            "tr",
                            { key: y.year },
                            React.createElement("td", null, y.year),
                            React.createElement("td", null, y.annual_extractable ?? "\u2014"),
                            React.createElement("td", null, y.total_extraction ?? "\u2014"),
                            React.createElement("td", null, y.stage_percent ?? "\u2014"),
                            React.createElement("td", null, y.categorization ?? "Unknown")
                          )
                        )
                      )
                    )
                  )
                : null,
              results && (!results.years || results.years.length === 0)
                ? React.createElement(
                    "p",
                    { className: "muted" },
                    "No data found for this combination. Try changing the filters."
                  )
                : null
            )
          )
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(React.createElement(App));
    </script>

    <!-- Include chatbot response handler -->
    <script src="js/response.js"></script>

    <!-- Chatbot UI functionality -->
    <script>
      class ChatBotUI {
        constructor() {
          this.drawer = document.getElementById('chatbot-drawer');
          this.toggle = document.getElementById('chatbot-toggle');
          this.closeBtn = document.getElementById('chatbot-close');
          this.messages = document.getElementById('chatbot-messages');
          this.input = document.getElementById('chatbot-input');
          this.sendBtn = document.getElementById('chatbot-send');
          this.isOpen = false;
          this.isTyping = false;

          this.init();
        }

        init() {
          // Event listeners
          this.toggle.addEventListener('click', () => this.toggleDrawer());
          this.closeBtn.addEventListener('click', () => this.closeDrawer());
          this.sendBtn.addEventListener('click', () => this.sendMessage());
          this.input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
              e.preventDefault();
              this.sendMessage();
            }
          });

          // Close drawer when clicking outside
          document.addEventListener('click', (e) => {
            if (!this.drawer.contains(e.target) && !this.toggle.contains(e.target) && this.isOpen) {
              this.closeDrawer();
            }
          });

          // Make this instance available globally for the response handler
          window.chatbotUI = this;
        }

        toggleDrawer() {
          if (this.isOpen) {
            this.closeDrawer();
          } else {
            this.openDrawer();
          }
        }

        openDrawer() {
          this.drawer.classList.add('open');
          this.isOpen = true;
          this.input.focus();
        }

        closeDrawer() {
          this.drawer.classList.remove('open');
          this.isOpen = false;
        }

        async sendMessage() {
          const message = this.input.value.trim();
          if (!message || this.isTyping) return;

          // Clear input
          this.input.value = '';

          // Add user message
          this.addMessage(message, 'user');

          // Get bot response
          try {
            const response = await window.chatbotInstance.handleMessage(message);
            this.addMessage(response, 'bot');
          } catch (error) {
            console.error('Error getting bot response:', error);
            this.addMessage('Sorry, I encountered an error. Please try again.', 'bot');
          }
        }

        addMessage(content, type) {
          const messageDiv = document.createElement('div');
          messageDiv.className = `message ${type}`;

          if (type === 'bot') {
            // Format bot messages with line breaks
            messageDiv.innerHTML = content.replace(/\n/g, '<br>');
          } else {
            messageDiv.textContent = content;
          }

          this.messages.appendChild(messageDiv);
          this.scrollToBottom();
        }

        setTyping(isTyping) {
          this.isTyping = isTyping;

          // Remove existing typing indicator
          const existingTyping = this.messages.querySelector('.message.typing');
          if (existingTyping) {
            existingTyping.remove();
          }

          if (isTyping) {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message typing';
            typingDiv.innerHTML = `
              <span>JalSathi is typing</span>
              <div class="typing-dots">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
              </div>
            `;
            this.messages.appendChild(typingDiv);
            this.scrollToBottom();
          }

          // Update send button state
          this.sendBtn.disabled = isTyping;
          this.input.disabled = isTyping;
        }

        scrollToBottom() {
          setTimeout(() => {
            this.messages.scrollTop = this.messages.scrollHeight;
          }, 100);
        }
      }

      // Initialize chatbot UI when DOM is loaded
      document.addEventListener('DOMContentLoaded', () => {
        new ChatBotUI();
      });
    </script>
  </body>
</html>
